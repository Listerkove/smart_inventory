<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point of Sale - Smart Inventory</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .pos-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-top: 20px;
        }
        .barcode-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .cart-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }
        .barcode-input {
            font-size: 24px;
            padding: 15px;
            width: 100%;
            border: 2px solid #28a745;
            border-radius: 8px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .cart-total {
            font-size: 24px;
            font-weight: bold;
            text-align: right;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #333;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: #007bff;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .quantity-btn:hover {
            background: #0056b3;
        }
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="dashboard.html" class="navbar-brand">Smart Inventory</a>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="products.html">Products</a></li>
                <li><a href="inventory.html">Inventory</a></li>
                <li><a href="replenishment.html">Replenishment</a></li>
                <li><a href="sales.html">Sales</a></li>
                <li><a href="reports.html">Reports</a></li>
                <li><a href="#" id="logoutLink">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h1>ðŸ›’ Point of Sale</h1>
        
        <div id="alert" class="alert" style="display: none;"></div>
        
        <div class="pos-container">
            <!-- Left side: Barcode scanner -->
            <div class="barcode-section">
                <h3>Scan Product</h3>
                <input type="text" id="barcodeInput" class="barcode-input" 
                       placeholder="Scan barcode or type SKU" autofocus>
                <p style="margin-top: 10px; color: #666;">
                    <small>Press Enter after scanning/typing</small>
                </p>
                
                <div style="margin-top: 20px;">
                    <h4>Recently Added</h4>
                    <div id="recentItems" style="max-height: 300px; overflow-y: auto;">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Right side: Shopping cart -->
            <div class="cart-section">
                <h3>Current Sale</h3>
                <div id="cartItems" style="max-height: 400px; overflow-y: auto;">
                    <!-- Cart items will appear here -->
                </div>
                <div class="cart-total">
                    Total: Ksh <span id="cartTotal">0.00</span>
                </div>
                <button id="checkoutBtn" class="btn btn-success" style="width:100%; margin-top:20px;" disabled>
                    Complete Sale (0 items)
                </button>
                <button id="clearCartBtn" class="btn" style="width:100%; margin-top:10px; background:#6c757d;">
                    Clear Cart
                </button>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        // ---------- AUTH CHECK (any authenticated user) ----------
        (async function() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            const user = await getUserInfo();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            window.currentUser = user;
            
            // Hide inventory link for clerk (already handled in other pages)
            const roles = user.roles ? user.roles.split(',') : [];
            const isManager = roles.includes('manager') || roles.includes('admin');
            const inventoryLink = document.querySelector('a[href="inventory.html"]');
            if (inventoryLink) {
                inventoryLink.style.display = isManager ? 'block' : 'none';
            }
        })();

        // ---------- LOGOUT ----------
        document.getElementById('logoutLink').addEventListener('click', function(e) {
            e.preventDefault();
            logout();
        });

        // ---------- POS STATE ----------
        let cart = [];  // array of { sku, barcode, name, quantity, unit_price, line_total }
        let total = 0;

        // DOM elements
        const barcodeInput = document.getElementById('barcodeInput');
        const cartItemsEl = document.getElementById('cartItems');
        const cartTotalEl = document.getElementById('cartTotal');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const clearCartBtn = document.getElementById('clearCartBtn');
        const alertDiv = document.getElementById('alert');

        // ---------- HELPER FUNCTIONS ----------
        function showAlert(message, type = 'error') {
            alertDiv.style.display = 'block';
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        async function fetchProduct(identifier) {
            // identifier can be barcode or SKU
            const token = localStorage.getItem('access_token');
            try {
                // Try as SKU first
                let response = await fetch(`/products/${identifier}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    return await response.json();
                }
                
                // If not found, try as barcode (need a different endpoint)
                // We don't have direct barcode lookup endpoint yet, but we can fetch all and filter
                // For simplicity, we'll assume the user scans barcode and we search via API
                // Better to implement a /products/by-barcode/{barcode} endpoint, but for now:
                const allProducts = await fetch('/products?limit=1000', {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(res => res.json());
                
                const product = allProducts.find(p => p.barcode === identifier);
                return product || null;
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        function addToCart(product, quantity = 1) {
            const existing = cart.find(item => item.sku === product.sku);
            if (existing) {
                existing.quantity += quantity;
                existing.line_total = existing.quantity * existing.unit_price;
            } else {
                cart.push({
                    sku: product.sku,
                    barcode: product.barcode,
                    name: product.name,
                    quantity: quantity,
                    unit_price: parseFloat(product.selling_price),
                    line_total: quantity * parseFloat(product.selling_price)
                });
            }
            updateCartDisplay();
        }

        function updateCartDisplay() {
            if (cart.length === 0) {
                cartItemsEl.innerHTML = '<p style="text-align:center; color:#999;">Cart is empty</p>';
                cartTotalEl.textContent = '0.00';
                checkoutBtn.disabled = true;
                checkoutBtn.innerHTML = 'Complete Sale (0 items)';
                return;
            }

            let html = '';
            total = 0;
            let itemCount = 0;

            cart.forEach((item, index) => {
                total += item.line_total;
                itemCount += item.quantity;
                html += `
                    <div class="cart-item">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>SKU: ${item.sku} | Ksh ${item.unit_price.toFixed(2)}</small>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">-</button>
                            <span style="min-width: 30px; text-align: center;">${item.quantity}</span>
                            <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">+</button>
                            <button class="remove-btn" onclick="removeItem(${index})">Ã—</button>
                        </div>
                        <div style="font-weight: bold; min-width: 80px; text-align: right;">
                            Ksh ${item.line_total.toFixed(2)}
                        </div>
                    </div>
                `;
            });

            cartItemsEl.innerHTML = html;
            cartTotalEl.textContent = total.toFixed(2);
            checkoutBtn.disabled = false;
            checkoutBtn.innerHTML = `Complete Sale (${itemCount} items)`;
        }

        window.updateQuantity = function(index, delta) {
            const item = cart[index];
            const newQty = item.quantity + delta;
            if (newQty <= 0) {
                removeItem(index);
            } else {
                item.quantity = newQty;
                item.line_total = item.quantity * item.unit_price;
                updateCartDisplay();
            }
        };

        window.removeItem = function(index) {
            cart.splice(index, 1);
            updateCartDisplay();
        };

        function clearCart() {
            cart = [];
            updateCartDisplay();
        }

        // ---------- BARCODE SCAN HANDLER ----------
        barcodeInput.addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const identifier = barcodeInput.value.trim();
                barcodeInput.value = '';
                
                if (!identifier) return;

                // Fetch product
                const product = await fetchProduct(identifier);
                if (!product) {
                    showAlert(`Product not found: ${identifier}`, 'error');
                    return;
                }

                if (!product.is_active) {
                    showAlert(`Product ${product.name} is inactive`, 'error');
                    return;
                }

                // Check stock availability (optional â€“ the backend will validate)
                if (product.quantity_in_stock <= 0) {
                    showAlert(`Product ${product.name} is out of stock`, 'error');
                    return;
                }

                addToCart(product, 1);
                showAlert(`âœ… Added ${product.name}`, 'success');
                
                // Add to recent items (simple implementation)
                const recentDiv = document.getElementById('recentItems');
                recentDiv.innerHTML = `<p>${product.name} - Ksh ${product.selling_price}</p>` + recentDiv.innerHTML;
            }
        });

        // ---------- CHECKOUT ----------
        checkoutBtn.addEventListener('click', async function() {
            if (cart.length === 0) return;

            const token = localStorage.getItem('access_token');
            const transaction_number = `POS-${Date.now()}`;
            const transaction_date = new Date().toISOString().slice(0, 19).replace('T', ' ');

            const saleData = {
                transaction_number: transaction_number,
                transaction_date: transaction_date,
                items: cart.map(item => ({
                    sku: item.sku,
                    quantity: item.quantity,
                    unit_price: item.unit_price
                }))
            };

            try {
                const response = await fetch('/sales', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(saleData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert(`âœ… Sale completed! Transaction #${data.transaction_number}`, 'success');
                    clearCart();
                    
                    // Optionally print receipt or show details
                    console.log('Transaction:', data);
                } else {
                    showAlert(data.detail || 'Sale failed', 'error');
                }
            } catch (error) {
                console.error(error);
                showAlert('Network error. Please try again.', 'error');
            }
        });

        // ---------- CLEAR CART ----------
        clearCartBtn.addEventListener('click', function() {
            if (cart.length > 0 && confirm('Clear entire cart?')) {
                clearCart();
            }
        });

        // ---------- AUTO-FOCUS ON PAGE LOAD ----------
        window.addEventListener('load', function() {
            barcodeInput.focus();
        });
    </script>
</body>
</html>